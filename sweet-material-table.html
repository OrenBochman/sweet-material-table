<link rel="import" href="../polymer/polymer.html"/>

<dom-module id="sweet-material-table">

  <link rel="import" href="../paper-checkbox/paper-checkbox.html"/>
  <link rel="import" href="../paper-material/paper-material.html"/>
  <link rel="import" href="../iron-icons/iron-icons.html"/>
  <link rel="import" href="../paper-menu/paper-menu.html"/>
  <link rel="import" href="../paper-item/paper-item.html"/>

  <link rel="import" href="./sweet-material-table-item.html"/>

  <style>

    :host {
      display: block;
      margin: 20px 24px;
      background: white;
    }

    #table .thead .tr .th,
    #table .tbody .tr .td,
    #table .tbody .tr sweet-material-table-item::shadow .td,
    #tableHeader, #tableFooter {
      padding-top: 18px;
      padding-bottom: 11px; /* -1px because of the border */
    }

    #table .thead .tr .th{
      padding-top: 14px;
      padding-bottom: 14px;
    }


    #tableHeader {
      font-size: 19px;
      padding-top: 18px;
      padding-bottom: 24px;
    }

    #table .thead .tr .th,
    #table .tbody .tr .td,
    #table .tbody .tr sweet-material-table-item::shadow .td {
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    #table .thead .tr .th,
    #table .tbody .tr .td,
    #table .tbody .tr sweet-material-table-item::shadow .td {
      padding-right: 56px;
    }

    #table .thead .tr .th:first-child,
    #table .tbody .tr .td:first-child,
    #table .tbody .tr sweet-material-table-item:first-child::shadow .td {
      padding-left: 24px;
    }

    #table .thead .tr .th:last-child,
    #table .tbody .tr .td:last-child,
    #table .tbody .tr sweet-material-table-item:last-child::shadow .td {
      padding-right: 24px;
    }

    #tableHeader {
      padding-left: 24px;
      padding-right: 24px;
    }

    #tableFooter {
      padding-left: 14px;
      padding-right: 14px;
    }

    #table .thead .tr .th.checkbox,
    #table .tbody .tr .td.checkbox,
    #table .thead .tr .th:not(.checkbox):first-child,
    #table .tbody .tr sweet-material-table-item:first-child::shadow .td {
      padding-right: 24px;
    }

    #tableHeader paper-material.absolute {
      position: absolute;
      z-index: 2;
      top: 48px;
    }

    #tableHeader .actions iron-icon {
      cursor: pointer;
      padding-right: 10px;
    }

    #tableHeader .actions iron-icon:last-child {
      padding-right: 0;
    }

    #tableHeader #filterListMenu {
      min-width: 240px;
    }

    #tableHeader #filterListMenu paper-checkbox {
      padding: 0 16px;
      font-size: 16px;
      display: block;
    }

    #tableHeader .alternate-action, #tableHeader .alternate-title {
      display: none;
    }

    #tableHeader.alternate-header {
      background: rgba(63, 81, 181, .30);
    }

    #tableHeader.alternate-header .alternate-action,
    #tableHeader.alternate-header .alternate-title {
      display: inline-block;
    }

    #tableHeader.alternate-header .primary-action,
    #tableHeader.alternate-header .primary-title {
      display: none;
    }

    #tableFooter {
      font-size: 12px;
      color: rgba(0, 0, 0, .54);

      line-height: 24px;
      height: 24px;
      max-height: 24px;
      overflow: visible;
    }

    #tableFooter #nextPage:not(.disabled),
    #tableFooter #previousPage:not(.disabled),
    #tableFooter #perPageSelector iron-icon,
    #tableFooter #perPageMenu paper-item {
      cursor: pointer;
    }

    #tableFooter > *:last-child {
      padding-right: 0;
    }

    #tableFooter #nextPage {
      width: 24px;
    }

    #tableFooter #previousPage {
      padding-right: 24px;
      width: 24px;
    }

    #tableFooter #paginationStatus {
      padding-right: 32px;
    }

    #tableFooter #perPageSelector {
      padding-right: 32px;
      width: 24px;

      position: relative;
    }

    #tableFooter #perPageSelector paper-material {
      position: absolute;
      top: 24px;
      left: 0;
      width: 140px;
    }

    #tableFooter #perPageValue {
      width: 40px;
    }

    #tableFooter #perPageLabel {

    }

    #table .thead .tr .th {
      font-size: 12px;
      color: rgba(0, 0, 0, .54);
      cursor: pointer;
    }

    #table .thead .tr .th:not(.sorted):hover .icon {
      color: rgba(0, 0, 0, .26);
      font-size: 16px;
    }

    #table .thead .tr .th {
      position: relative;
      overflow: visible;
    }

    #table .thead .tr iron-icon.sorted-ascending,
    #table .thead .tr iron-icon.sorted-descending {
      color: rgba(0, 0, 0, .87);
      position: absolute;
      left: -18px;
      width: 16px;
      height: 16px;
    }

    #table .thead .tr iron-icon.sorted-ascending {
      margin-top: -2px;
    }

    #table .thead .tr iron-icon.sorted-descending {
      margin-top: 3px;
    }

    #table .thead .tr .th:not(.sorted-ascending):not(.sorted-descending) iron-icon {
      display: none;
    }

    #table .thead .tr .th:not(.sorted-ascending) .sorted-ascending,
    #table .thead .tr .th:not(.sorted-descending) .sorted-descending {
      opacity: 0.4;
    }

    #table .thead .tr .th.sorted-ascending .sorted-ascending,
    #table .thead .tr .th.sorted-descending .sorted-descending {

    }

    #table .tbody .tr {
      border-top: 1px solid rgba(0, 0, 0, .22);
    }

    #table .tbody .tr:hover {
      background: #eeeeee;
    }

    #table .tbody .tr.selected {
      background: #f5f5f5;
    }

    #table .tbody .tr .td,
    #table .tbody .tr sweet-material-table-item::shadow .td {
      font-size: 13px;
      color: rgba(0, 0, 0, .87);
      line-height: 13px;
    }

  </style>

  <template>

    <paper-material>

      <div id="tableHeader" class="horizontal layout">
        <div id="title" class="label flex primary-title">[[title]]</div>
        <div class="label flex alternate-title">[[alternateHeaderTitle]]</div>
        <div class="actions">

          <paper-material class="absolute">
            <paper-menu id="filterListMenu" style="display: none;">
              <template is="dom-repeat" items="[[availableColumns]]" as="column">

                <paper-checkbox checked$="{{_isColumnVisible(column)}}"
                                column="[[column]]"
                                on-click="_selectColumn">
                  <span>[[column.title]]</span>
                </paper-checkbox>

              </template>
            </paper-menu>
          </paper-material>

          <template is="dom-repeat" items="[[actions]]" as="action">

            <iron-icon class="alternate-action"
                       icon="[[action.icon]]"
                       action="[[action.name]]"
                       on-click="_actionClicked"></iron-icon>

          </template>

          <iron-icon class="primary-action" icon="icons:filter-list" on-click="_filterListClicked"></iron-icon>
          <iron-icon class="primary-action" icon="icons:more-vert" on-click="_moreClicked"></iron-icon>
        </div>
      </div>
      <div id="table">
        <div class="thead">
          <div class="tr horizontal layout">
            <div class="th checkbox">
              <paper-checkbox id="selectAll" on-click="_selectAll"></paper-checkbox>
            </div>
            <template is="dom-repeat" items="{{columns}}" as="column">
              <div class="th flex" data-column$="[[column.key]]" on-click="_sortColumn">

                <iron-icon class="sorted-descending"
                           icon="icons:arrow-drop-down"></iron-icon>

                <iron-icon class="sorted-ascending"
                           icon="icons:arrow-drop-up"></iron-icon>

                <span>[[column.title]]</span>
              </div>
            </template>
          </div>
        </div>
        <div class="tbody" id="tbody">

          <template is="dom-repeat" items="{{data}}" as="instance">
            <div class="tr horizontal layout" index="[[index]]">
              <div class="td checkbox">
                <paper-checkbox on-click="_selectRow" index="[[index]]"></paper-checkbox>
              </div>

              <template is="dom-repeat" items="{{columns}}" as="column">
                <sweet-material-table-item class="flex" field="[[column]]"
                                           row="{{instance}}"></sweet-material-table-item>
              </template>
            </div>
          </template>

        </div>
      </div>

      <div id="tableFooter" class="end-justified" style="text-align: right;">
        <span id="perPageLabel">Rows per page:</span>
        <span id="perPageValue">[[perPage]]</span>
        <span id="perPageSelector">
          <iron-icon icon="icons:arrow-drop-down" on-click="_dropDownPerPageMenuClicked"></iron-icon>
          <paper-material>
            <paper-menu id="perPageMenu" style="display: none;">
              <paper-item value="10" on-click="_perPageSelectionChanged">10</paper-item>
              <paper-item value="50" on-click="_perPageSelectionChanged">50</paper-item>
              <paper-item value="100" on-click="_perPageSelectionChanged">100</paper-item>
            </paper-menu>
          </paper-material>
        </span>
        <span id="paginationStatus" class="flex">
          <span>[[start]]</span>
          <span>-</span>
          <span>[[_getEndValue(start,perPage)]]</span>
          <span> of </span>
          <span>[[total]]</span>
        </span>
        <span id="previousPage" class="flex" on-click="_previousPageClicked">
          <iron-icon icon="icons:chevron-left"></iron-icon>
        </span>
        <span id="nextPage" class="flex" on-click="_nextPageClicked">
          <iron-icon icon="icons:chevron-right"></iron-icon>
        </span>
      </div>

    </paper-material>

  </template>

  <script>
    /**
     *
     * Limitations:
     *
     * - This module currently only supports one sort direction, so no sorting on multiple columns.
     *
     * TODO
     *
     * - integrate iron-list
     * - Custom cell renderers (provide any element tag name you want)
     * - th paper-tooltips
     * - A proper paper-dropdown solution
     *
     */
    Polymer({
      is: 'sweet-material-table',
      properties: {
        title: String,
        schema: {
          type: Object
        },
        data: {
          type: Array,
          notify: true
        },
        columns: {
          type: Array,
          notify: true,
          value: function () {
            return [];
          }
        },
        availableColumns: {
          type: Array,
          value: function () {
            return [];
          }
        },
        perPage: {
          type: Number,
          notify: true,
          default: 50
        },
        start: {
          type: Number,
          notify: true,
          default: 0
        },
        total: {
          type: Number,
          default: 0
        },
        sortColumn: {
          type: String,
          notify: true
        },
        sortDirection: {
          type: String,
          notify: true
        },
        selectedIndexes: {
          type: Array,
          notify: true,
          value: function () {
            return [];
          }
        },
        actions: {
          type: Array
        }
      },
      observers: [
        '_schemaChanged(schema)',
        '_selectedIndexesChanged(selectedIndexes.splices)',
        '_paginationChanged(start,perPage,total)',
        '_sortDirectionChanged(sortColumn,sortDirection)'
      ],
      ready: function () {

      },
      _schemaChanged: function () {

        var schema = this.schema;

        if (schema && schema.title && !this.title) {
          this.set('title', schema.title);
        }

        if (!this.columns.length && schema) {
          for (var key in schema.properties) {
            this.push('columns', {
              title: schema.properties[key].title,
              key: key
            });
          }
        }

        if (!this.availableColumns.length && schema) {
          for (var key in schema.properties) {
            this.push('availableColumns', {
              title: schema.properties[key].title,
              key: key
            });
          }
        }
      },
      _paginationChanged: function (start, perPage, total) {
        if (start === 0) {
          this.$.previousPage.classList.add('disabled');
        } else {
          this.$.previousPage.classList.remove('disabled');
        }

        if (start + perPage >= total) {
          this.$.nextPage.classList.add('disabled');
        } else {
          this.$.nextPage.classList.remove('disabled');
        }

      },

      _getTitle: function (title, schemaTitle) {
        debugger;
        if (title) {
          return title;
        }
        if (schemaTitle) {
          return schemaTitle;
        }
        return '';
      },
      _getEndValue: function (start, perPage) {
        return start + perPage;
      },

      _dropDownPerPageMenuClicked: function () {
        var el = this.$.perPageMenu;
        if (el.style.display !== 'block') {
          el.style.display = 'block';
        } else {
          el.style.display = 'none';
        }
      },
      _filterListClicked: function () {
        var el = this.$.filterListMenu;
        if (el.style.display !== 'block') {
          el.style.display = 'block';
        } else {
          el.style.display = 'none';
        }
      },

      _nextPageClicked: function (e) {
        if (e.currentTarget.className.match(/disabled/)) {
          return;
        }
        this.start = this.start + this.perPage;
      },
      _previousPageClicked: function (e) {
        if (e.currentTarget.className.match(/disabled/)) {
          return;
        }
        var newStart = this.start - this.perPage;
        if (newStart < 0) {
          this.start = 0;
        } else {
          this.start = newStart;
        }
      },
      _perPageSelectionChanged: function (event) {
        this.perPage = parseInt(event.target.attributes.value.value);
        return this._dropDownPerPageMenuClicked(); // Gotta toggle off this paper-menu
      },

      _isColumnVisible: function (column) {
        for (var i = 0, ii = this.columns.length; i < ii; i++) {
          if (this.columns[i].key === column.key) {
            return true;
          }
        }
        return false;
      },
      _selectColumn: function (e) {
        var column = e.currentTarget.column;

        var removedSelection = false;
        for (var i = 0, ii = this.columns.length; i < ii; i++) {
          if (this.columns[i].key === column.key) {
            this.splice('columns', i, 1);
            removedSelection = true;
            break;
          }
        }

        if (!removedSelection) {
          this.push('columns', column);
        }

      },
      _sortColumn: function (e) {
        var column = e.currentTarget.attributes['data-column'].value;

        if (this.sortColumn === column) {
          if (this.sortDirection === 'ascending') {
            this.sortColumn = null;
            this.sortDirection = null;
          } else {
            this.sortDirection = 'ascending';
          }
        } else {
          this.sortColumn = column;
          this.sortDirection = 'descending';
        }
      },
      _sortDirectionChanged: function (sortColumn, sortDirection) {
        // Clear the classes on the ths
        var tableHeaders = this.$.table.querySelectorAll('.thead .th');

        for (var i = 0, ii = tableHeaders.length; i < ii; i++) {
          var th = tableHeaders[i];
          th.classList.remove('sorted-ascending');
          th.classList.remove('sorted-descending');

          if (this.sortDirection
              && this.sortColumn
              && th.attributes['data-column'] && th.attributes['data-column'].value === this.sortColumn) {
            th.classList.add('sorted-' + this.sortDirection);
          }
        }
      },

      _selectAll: function () {
        if (this.selectedIndexes.length === this.data.length) {
          this.splice('selectedIndexes', 0, this.data.length);
        } else {
          this.splice('selectedIndexes', 0, this.selectedIndexes.length);
          for (var i = 0, ii = this.data.length; i < ii; i++) {
            this.push('selectedIndexes', i);
          }
        }
      },
      _selectRow: function (e) {
        var index = e.currentTarget.index;
        var indexOf = this.selectedIndexes.indexOf(index);
        if (indexOf === -1) {
          this.push('selectedIndexes', index);
        } else {
          this.splice('selectedIndexes', indexOf, 1);
        }
      },
      _isRowSelected: function (index) {
        return this.selectedIndexes.indexOf(index) !== -1;
      },
      _selectedIndexesChanged: function () {
        var rows = this.$.table.querySelectorAll('.tbody .tr');
        for (var i = 0, ii = rows.length; i < ii; i++) {
          rows[i].querySelector('.td:first-child paper-checkbox').checked = false;
          rows[i].classList.remove('selected');
        }
        var selectedIndexesLength = this.selectedIndexes.length;
        for (var i = 0, ii = selectedIndexesLength; i < ii; i++) {
          rows[this.selectedIndexes[i]].querySelector('.td:first-child paper-checkbox').checked = true;
          rows[i].classList.add('selected');
        }

        this.$.selectAll.checked = (this.selectedIndexes && this.data && selectedIndexesLength === this.data.length);

        if (selectedIndexesLength) {
          this.$.tableHeader.classList.add('alternate-header');
          this.alternateHeaderTitle = selectedIndexesLength + ' row' + (selectedIndexesLength === 1 ? '' : 's') + ' selected';
        } else {
          this.$.tableHeader.classList.remove('alternate-header');
        }
      },

      _actionClicked: function (e) {
        var actionName = e.currentTarget.action;
        this.fire('action', actionName);
      }

    })
  </script>
</dom-module>